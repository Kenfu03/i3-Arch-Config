#!/bin/bash

#!/usr/bin/env bash

# rofi-power-menu (modi-friendly)
#
# When called with no args: print menu items.
# When called with an arg: perform the action.

log=/tmp/rofi-i3lock.log
: >"$log"

if [ -z "$@" ]; then
    # Print the menu items (plain text)
    echo "Lock"
    echo "Logout"
    echo "Reboot"
    echo "Shutdown"
    exit 0
fi

# normalize arg (strip surrounding whitespace/newlines)
choice="$(echo "$@" | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')"

case "$choice" in
  *Lock*)
    # Try to find sensible environment values
    DISPLAY_VAL="${DISPLAY:-:0}"

    if [ -n "$XAUTHORITY" ] && [ -f "$XAUTHORITY" ]; then
      XAUTH="$XAUTHORITY"
    elif [ -f "$HOME/.Xauthority" ]; then
      XAUTH="$HOME/.Xauthority"
    elif [ -f "/run/user/$UID/lyxauth" ]; then
      XAUTH="/run/user/$UID/lyxauth"
    elif [ -f "/run/user/$UID/.Xauthority" ]; then
      XAUTH="/run/user/$UID/.Xauthority"
    else
      XAUTH=""
    fi

    printf 'Attempting lock: DISPLAY=%s XAUTH=%s\n' "$DISPLAY_VAL" "$XAUTH" >>"$log"

    # Prefer i3lock (non-forking) so we can check its exit status.
    if [ -n "$XAUTH" ]; then
      # run i3lock without forking (-n) and capture output
      setsid env DISPLAY="$DISPLAY_VAL" XAUTHORITY="$XAUTH" i3lock -n -c 000000 >>"$log" 2>&1
      rc=$?
    else
      # No XAUTH found — try i3lock anyway
      setsid env DISPLAY="$DISPLAY_VAL" i3lock -n -c 000000 >>"$log" 2>&1
      rc=$?
    fi

    if [ $rc -eq 0 ]; then
      printf "i3lock success (rc=%d)\n" "$rc" >>"$log"
      exit 0
    else
      printf "i3lock failed (rc=%d). Log:\n" "$rc" >>"$log"
      tail -n +1 "$log" >>"$log"
      # Fallback: let systemd lock the session (works for many setups)
      loginctl lock-sessions >>"$log" 2>&1 || loginctl lock-session $(loginctl | awk '/'"$USER"'/ {print $1; exit}') >>"$log" 2>&1 || true
      exit 0
    fi
    ;;

  *Logout*)
    i3-msg exit
    ;;

  *Reboot*)
    systemctl reboot
    ;;

  *Shutdown*)
    systemctl poweroff
    ;;

  *)
    # unknown option — just ignore
    exit 0
    ;;
esac
